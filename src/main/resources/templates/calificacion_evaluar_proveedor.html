<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale.">
  <title>Calificar Proveedor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
  <div class="container py-5">
    <h2 class="text-center mb-4 title-wayas">‚≠ê Calificar Proveedor tras Compra</h2>

    <div th:if="${mensajeExito}" class="alert alert-success alert-dismissible fade show" role="alert" th:text="${mensajeExito}">...</div>
    <div th:if="${mensajeError}" class="alert alert-danger alert-dismissible fade show" role="alert" th:text="${mensajeError}">...</div>

    <!-- FORMULARIO SOLO PARA ADMIN -->
    <div sec:authorize="hasAuthority('ADMIN')">
      
      <!-- INICIO DE LA CORRECCI√ìN: Formulario POST real -->
      <form th:action="@{/calificacion/guardar}" method="post" th:object="${calificacion}">
        <div class="card mb-4 shadow">
          <div class="card-body">
            <h5 class="card-title">üì¶ Seleccionar compra registrada</h5>
            <div class="row g-3">
              <div class="col-md-12">
                <label for="compraSelect" class="form-label">Compra (Req. - Proveedor) <span class="text-danger">*</span></label>
                <select class="form-select" id="compraSelect" name="idCompra" required onchange="actualizarProveedor(this)">
                  <option value="" selected disabled>Seleccionar compra...</option>
                  <!-- Iteramos sobre las compras que env√≠a el Controller -->
                  <option th:each="compra : ${compras}" 
                          th:value="${compra.id}" 
                          th:text="${compra.codigoCompra + ' - ' + compra.proveedor.razonSocial}"
                          th:attr="data-proveedor-id=${compra.proveedor.idProv}">
                  </option>
                  <option th:if="${#lists.isEmpty(compras)}" disabled>No hay compras pendientes de calificar</option>
                </select>
                <!-- Input oculto para enviar el ID del proveedor -->
                <input type="hidden" id="idProveedorHidden" name="idProveedor" value="" />
              </div>
            </div>
          </div>
        </div>

        <!-- Calificaci√≥n por criterios -->
        <div class="card mb-4 shadow">
          <div class="card-body">
            <h5 class="card-title">üìù Evaluar proveedor</h5>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Calidad del insumo <span class="text-danger">*</span></label>
                <select class="form-select" name="calidad" required>
                  <option value="3">Bueno</option>
                  <option value="2" selected>Regular</option>
                  <option value="1">Malo</option>
                </select>
              </div>
            
              <div class="col-md-4">
                <label class="form-label">Puntualidad en entrega <span class="text-danger">*</span></label>
                <select class="form-select" name="puntualidad" required>
                  <option value="3">Bueno</option>
                  <option value="2" selected>Regular</option>
                  <option value="1">Malo</option>
                </select>
              </div>
              <div class="col-md-12">
                <label class="form-label">Observaciones (opcional)</label>
                <textarea class="form-control" name="observaciones" rows="3"
                  placeholder="Ej. Entrega puntual pero empaques da√±ados..."></textarea>
              </div>
              <div class="col-12 text-end">
                <button type="submit" class="btn btn-success">‚úÖ Guardar calificaci√≥n</button>
              </div>
            </div>
          </div>
        </div>
      </form>
      <!-- FIN DE LA CORRECCI√ìN -->

    </div>
    
    <div class="alert alert-warning" role="alert" sec:authorize="!hasAuthority('ADMIN')">
      No tienes permisos para calificar proveedores.
    </div>

    <!-- Volver -->
    <div class="text-center mt-4">
      <a th:href="@{/gestion_calificacion}" class="btn btn-secondary">‚¨Ö Volver a Gesti√≥n de Calificaci√≥n</a>
    </div>
  </div>
  
  <!-- SCRIPT PARA ACTUALIZAR EL PROVEEDOR OCULTO -->
  <script>
    function actualizarProveedor(select) {
      const selectedOption = select.options[select.selectedIndex];
      const proveedorId = selectedOption.getAttribute('data-proveedor-id');
      document.getElementById('idProveedorHidden').value = proveedorId;
    }
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
