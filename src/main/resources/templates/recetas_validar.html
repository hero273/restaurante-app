<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Validar Receta</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
  <div class="container py-5">
    <h2 class="text-center mb-4 title-wayas">✅ Validar Receta</h2>

    <!-- Mensajes de Alerta -->
    <div th:if="${mensajeExito}" class="alert alert-success alert-dismissible fade show" role="alert" th:text="${mensajeExito}"></div>
    <div th:if="${mensajeError}" class="alert alert-danger alert-dismissible fade show" role="alert" th:text="${mensajeError}"></div>

    <!-- Selección de receta en revisión -->
    <div class="card mb-4 shadow" sec:authorize="hasAuthority('ADMIN')">
      <div class="card-body">
        <h5 class="card-title">📋 Recetas en revisión</h5>
        
        <!-- Este formulario es GET: recarga la página mostrando los detalles de la receta seleccionada -->
        <form th:action="@{/recetas/validar}" method="get" class="row g-3">
          <div class="col-md-8">
            <select class="form-select" name="id"> <!-- El name="id" es el @RequestParam -->
              <option value="" selected disabled>Seleccionar receta...</option>
              <option th:each="receta : ${recetasEnRevision}"
                      th:value="${receta.id}"
                      th:text="${receta.nombre}"
                      th:selected="${recetaSeleccionada != null && receta.id == recetaSeleccionada.id}">
              </option>
              <option th:if="${#lists.isEmpty(recetasEnRevision)}" disabled>No hay recetas en revisión</option>
            </select>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-outline-primary w-100">🔍 Ver detalles</button>
          </div>
        </form>
      </div>
    </div>
    
    <div class="alert alert-warning" role="alert" sec:authorize="!hasAuthority('ADMIN')">
      No tienes permisos para validar recetas.
    </div>

    <!-- Detalles de la receta (Solo se muestra si se seleccionó una) -->
    <div class="card mb-4 shadow" th:if="${recetaSeleccionada != null}" sec:authorize="hasAuthority('ADMIN')">
      <div class="card-body">
        <h5 class="card-title">📄 Detalles de: <span th:text="${recetaSeleccionada.nombre}">Lomo saltado</span></h5>
        <p><strong>Categoría:</strong> <span th:text="${recetaSeleccionada.categoria}">Plato principal</span></p>
        <p><strong>Porciones:</strong> <span th:text="${recetaSeleccionada.porciones}">4</span></p>
        <p><strong>Descripción:</strong> <span th:text="${recetaSeleccionada.descripcion}">Salteado de...</span></p>

        <h6 class="mt-3">🥕 Ingredientes:</h6>
        <ul>
          <!-- Iteramos sobre los detalles de la receta seleccionada -->
          <li th:each="detalle : ${recetaSeleccionada.detalles}"
              th:text="${detalle.cantidad + ' ' + detalle.unidadMedida + ' de ' + detalle.insumo.descripcion}">
            500 g de carne de res
          </li>
        </ul>

        <h6 class="mt-3">👨‍🍳 Pasos:</h6>
        <!-- Usamos th:utext para preservar los saltos de línea (\n) -->
        <p style="white-space: pre-wrap;" th:utext="${recetaSeleccionada.pasos}">1. Cortar la carne...</p>
      </div>

      <!-- Comentarios y acciones (Botones POST) -->
      <div class="card-footer">
        <h5 class="card-title">💬 Comentarios de validación (Opcional)</h5>
        <!-- (Este textarea es solo visual por ahora, no se guarda) -->
        <textarea class="form-control mb-3" rows="3" placeholder="Ej. Ajustar cantidad de papas para porciones grandes..."></textarea>

        <div class="d-flex justify-content-between">
          <!-- Formulario para RECHAZAR -->
          <form th:action="@{/recetas/validar/rechazar}" method="post" onsubmit="return confirm('¿Rechazar esta receta?')">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="recetaId" th:value="${recetaSeleccionada.id}" />
            <button type="submit" class="btn btn-danger">❌ Rechazar receta</button>
          </form>
          
          <!-- Formulario para APROBAR -->
          <form th:action="@{/recetas/validar/aprobar}" method="post" onsubmit="return confirm('¿Aprobar esta receta?')">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="recetaId" th:value="${recetaSeleccionada.id}" />
            <button type="submit" class="btn btn-success">✅ Aprobar receta</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Historial de validaciones (Dinámico) -->
    <div class="card shadow">
      <div class="card-body">
        <h5 class="card-title">📚 Historial de validaciones</h5>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead class="table-light">
              <tr>
                <th>Receta</th>
                <th>Estado</th>
                <th>Comentario</th>
              </tr>
            </thead>
            <tbody>
              <!-- Recetas Aprobadas -->
              <tr th:each="receta : ${recetasAprobadas}">
                <td th:text="${receta.nombre}">Lomo saltado</td>
                <td><span class="badge bg-success" th:text="${receta.estado}">Aprobada</span></td>
                <td>Receta lista para producción</td>
              </tr>
              <!-- Recetas Rechazadas -->
              <tr th:each="receta : ${recetasRechazadas}">
                <td th:text="${receta.nombre}">Crema de zapallo</td>
                <td><span class="badge bg-danger" th:text="${receta.estado}">Rechazada</span></td>
                <td>Faltan pasos de cocción</td>
              </tr>
              <tr th:if="${#lists.isEmpty(recetasAprobadas) and #lists.isEmpty(recetasRechazadas)}">
                <td colspan="3" class="text-center text-muted">Aún no se han validado recetas.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Volver -->
    <div class="text-center mt-4">
      <a th:href="@{/gestion_recetas}" class="btn btn-secondary">⬅ Volver a Gestión de Recetas</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
