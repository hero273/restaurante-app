<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ingresar Compras al Inventario</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
  <div class="container py-5">
    <h2 class="text-center mb-4 title-wayas">ðŸ“¥ Requerimientos Comprados</h2>

    <div th:if="${mensajeExito}" class="alert alert-success alert-dismissible fade show" role="alert" th:text="${mensajeExito}">...</div>
    <div th:if="${mensajeError}" class="alert alert-danger alert-dismissible fade show" role="alert" th:text="${mensajeError}">...</div>

    <!-- Tabla de requerimientos -->
    <div class="card shadow mb-4">
      <div class="card-body">
        <h5 class="card-title">ðŸ“¦ Requerimientos pendientes de ingreso</h5>
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead class="table-light">
              <tr>
                <th>CÃ³digo Req.</th>
                <th>Proveedor (Referencial)</th>
                <th>Fecha Generado</th>
                <th>Insumos</th>
                <th>Estado</th>
                <th>AcciÃ³n</th>
              </tr>
            </thead>
            <!-- INICIO DE LA CORRECCIÃ“N -->
            <tbody>
              <!-- Iteramos sobre la variable ${requerimientos} que envÃ­a InventarioController -->
              <tr th:each="req : ${requerimientos}">
                <td th:text="${req.codigoRequerimiento}">REQ-0001</td>
                <!-- Mostramos el proveedor del primer Ã­tem como referencia -->
                <td th:text="${!#lists.isEmpty(req.detalles) ? req.detalles[0].proveedor?.razonSocial : 'N/A'}">Distribuidora</td>
                <td th:text="${#temporals.format(req.fechaGeneracion, 'dd-MM-yyyy')}">2025-10-15</td>
                <td>
                  <!-- Hacemos un bucle anidado para los insumos de CADA requerimiento -->
                  <ul class="mb-0" style="padding-left: 20px;">
                    <li th:each="det : ${req.detalles}" 
                        th:text="${det.insumo.descripcion + ' - ' + #numbers.formatDecimal(det.cantidad, 1, 'COMMA', 3, 'POINT') + ' ' + det.insumo.unidadMedida}">
                      Tomate - 12 kg
                    </li>
                  </ul>
                </td>
                <td><span class="badge bg-info text-dark" th:text="${req.estado}">Comprado</span></td>
                <td>
                  <!-- Este formulario apunta al endpoint correcto del InventarioController -->
                  <form th:action="@{/inventario/ingresar/procesar/{id}(id=${req.id})}" method="post"
                        onsubmit="return confirm('Â¿Seguro que quieres ingresar este requerimiento (' + th:text_s_inline('\'[[${req.codigoRequerimiento}]]\'') + ') al inventario?');">
                    <button type="submit" class="btn btn-sm btn-success">Aprobar e ingresar</button>
                  </form>
                </td>
              </tr>
              <!-- Mensaje si no hay requerimientos pendientes -->
              <tr th:if="${#lists.isEmpty(requerimientos)}">
                <td colspan="6" class="text-center text-muted">No hay requerimientos comprados pendientes de ingreso.</td>
              </tr>
            </tbody>
            <!-- FIN DE LA CORRECCIÃ“N -->
          </table>
        </div>
      </div>
    </div>
    
    <div class="text-center mt-4">
      <a th:href="@{/gestion_inventario}" class="btn btn-secondary">â¬… Volver a GestiÃ³n de Inventario</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
