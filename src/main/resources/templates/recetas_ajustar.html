<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ajustar Receta</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
  <div class="container py-5">
    <h2 class="text-center mb-4 title-wayas">✏️ Ajustar Receta</h2>

    <!-- Mensajes de Alerta -->
    <div th:if="${mensajeExito}" class="alert alert-success alert-dismissible fade show" role="alert" th:text="${mensajeExito}"></div>
    <div th:if="${mensajeError}" class="alert alert-danger alert-dismissible fade show" role="alert" th:text="${mensajeError}"></div>

    <!-- Selección de receta rechazada -->
    <div class="card mb-4 shadow" sec:authorize="hasAuthority('ADMIN')">
      <div class="card-body">
        <h5 class="card-title">📋 Lista de Recetas Rechazadas</h5>
        <p>Selecciona una receta. Puedes editarla (te llevará a la pantalla de registro) o reenviarla directamente si ya la ajustaste.</p>
        
        <form th:action="@{/recetas/ajustar/reenviar}" method="post">
           <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
           
          <div class="row g-3 align-items-end">
            <div class="col-md-7">
              <label for="recetaSelect" class="form-label">Receta Rechazada</label>
              <select class="form-select" id="recetaSelect" name="recetaId" required onchange="actualizarBotonEditar(this)">
                <option value="" selected disabled>Seleccionar receta...</option>
                <option th:each="receta : ${recetasRechazadas}" 
                        th:value="${receta.id}" 
                        th:text="${receta.nombre}">
                </option>
                <option th:if="${#lists.isEmpty(recetasRechazadas)}" disabled>No hay recetas rechazadas</option>
              </select>
            </div>
            
            <!-- Botón de Editar (es un Link GET) -->
            <div class="col-md-2">
                <a id="btnEditarReceta" th:href="@{/recetas/registrar}" class="btn btn-warning w-100 disabled" title="Ajustar y guardar cambios">
                  ✏️ Editar
                </a>
            </div>
            
            <!-- Botón de Reenviar (es un Submit POST) -->
            <div class="col-md-3">
                <button type="submit" class="btn btn-outline-success w-100">
                  📤 Reenviar a Validación
                </button>
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Historial de recetas "En Revisión" -->
    <div class="card shadow mt-5">
      <div class="card-body">
        <h5 class="card-title">📚 Recetas enviadas (En Revisión)</h5>
         <div class="table-responsive">
          <table class="table table-striped">
            <thead class="table-light">
              <tr>
                <th>Receta</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="rev : ${recetasEnRevision}">
                <td th:text="${rev.nombre}">Lomo saltado</td>
                <td><span class="badge bg-warning text-dark">En Revisión</span></td>
              </tr>
              <tr th:if="${#lists.isEmpty(recetasEnRevision)}">
                <td colspan="2" class="text-center text-muted">No hay recetas en revisión.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>


    <!-- Volver -->
    <div class="text-center mt-4">
      <a th:href="@{/gestion_recetas}" class="btn btn-secondary">⬅ Volver a Gestión de Recetas</a>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script th:inline="javascript">
    /*<![CDATA[*/
    
    // Habilita el botón "Editar" solo si se selecciona una receta
    function actualizarBotonEditar(select) {
        const selectedId = select.value;
        const btnEditar = document.getElementById('btnEditarReceta');
        
        if (selectedId) {
            // Construimos la URL de edición (ej. /recetas/editar/5)
            const url = /*[[@{/recetas/editar/}]]*/ '/recetas/editar/' + selectedId;
            btnEditar.setAttribute('href', url);
            btnEditar.classList.remove('disabled');
        } else {
            btnEditar.setAttribute('href', '#');
            btnEditar.classList.add('disabled');
        }
    }
    
    /*]]>*/
  </script>
</body>
</html>
